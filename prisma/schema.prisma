generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "windows", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model bill_payments {
  payment_id     Int             @id @default(autoincrement())
  amount         Decimal         @db.Decimal(12, 2)
  payment_date   DateTime?       @default(now()) @db.Timestamp(6)
  method         payment_method?
  status         payment_status? @default(completed)
  reference      String?         @db.VarChar(255)
  paid_by        Int?
  transaction_id String?         @unique @db.VarChar(100)
  online_type    online_type?
  note           String?         @db.VarChar(500)
  users          users?          @relation(fields: [paid_by], references: [user_id], map: "fk_bill_payments_paid_by")
  bills          bills[]

  @@index([paid_by], map: "idx_bill_payments_paid_by")
}

model bills {
  bill_id              Int            @id @default(autoincrement())
  tenant_user_id       Int
  room_id              Int?
  payment_id           Int?
  bill_number          String?        @unique @db.VarChar(100)
  billing_period_start DateTime?      @db.Date
  billing_period_end   DateTime?      @db.Date
  due_date             DateTime?      @db.Date
  total_amount         Decimal?       @default(0) @db.Decimal(12, 2)
  paid_amount          Decimal?       @default(0) @db.Decimal(12, 2)
  status               bill_status?   @default(draft)
  description          String?
  penalty_amount       Decimal?       @default(0.00) @db.Decimal(12, 2)
  created_by           Int?
  created_at           DateTime?      @default(now()) @db.Timestamp(6)
  updated_at           DateTime?      @db.Timestamp(6)
  deleted_at           DateTime?      @db.Timestamp(6)
  users                users?         @relation(fields: [created_by], references: [user_id], onDelete: SetNull, map: "fk_bills_created_by")
  bill_payments        bill_payments? @relation(fields: [payment_id], references: [payment_id], map: "fk_bills_payment")
  tenants              tenants        @relation(fields: [tenant_user_id], references: [user_id], map: "fk_bills_tenant")
  rooms                rooms?         @relation(fields: [room_id], references: [room_id], map: "fk_bills_room") // <-- ADDED RELATION

  // This prevents creating two bills for the same room for the same start date
  @@unique([room_id, billing_period_start])
  @@index([status], map: "idx_bills_status")
  @@index([tenant_user_id], map: "idx_bills_tenant_user_id")
  @@index([room_id], map: "idx_bills_room_id")
}

model building_managers {
  user_id       Int       @id
  building_id   Int
  assigned_from DateTime? @db.Date
  assigned_to   DateTime? @db.Date
  note          String?   @db.VarChar(255)
  buildings     buildings @relation(fields: [building_id], references: [building_id], onDelete: Cascade, map: "fk_building_managers_building")
  users         users     @relation(fields: [user_id], references: [user_id], onDelete: Cascade, map: "fk_building_managers_user")

  @@index([building_id], map: "idx_building_managers_building_id")
  @@index([user_id], map: "idx_building_managers_user_id")
}

model building_owner {
  user_id    Int       @id
  notes      String?
  created_at DateTime? @default(now()) @db.Timestamp(6)
  users      users     @relation(fields: [user_id], references: [user_id], onDelete: Cascade, map: "fk_building_owner_user")
}

model buildings {
  building_id       Int                 @id @default(autoincrement())
  name              String              @db.VarChar(200)
  address           String?             @db.VarChar(300)
  number_of_floors  Int?
  total_area        Float?
  created_at        DateTime?           @default(now()) @db.Timestamp(6)
  updated_at        DateTime?           @db.Timestamp(6)
  is_active         Boolean?            @default(true)
  building_managers building_managers[]
  floor_plans       floor_plans[]
  regulations       regulations[]
  rooms             rooms[]
}

model contract_addendums {
  addendum_id    Int            @id @default(autoincrement())
  contract_id    Int
  type           addendum_type? @default(general)
  version        Int?           @default(1)
  summary        String?        @db.VarChar(500)
  changes        Json?
  effective_date DateTime?      @db.Date
  created_by     Int
  created_at     DateTime?      @default(now()) @db.Timestamp(6)
  note           String?
  contracts      contracts      @relation(fields: [contract_id], references: [contract_id], onDelete: Cascade, map: "fk_addendum_contract")
  users          users          @relation(fields: [created_by], references: [user_id], onDelete: SetNull, map: "fk_addendum_created_by_user")

  @@unique([contract_id, version], map: "uniq_contract_addendum_version")
  @@index([contract_id], map: "idx_contract_addendums_contract_id")
  @@index([created_by], map: "idx_contract_addendums_created_by")
}

model contracts {
  contract_id        Int                  @id @default(autoincrement())
  room_id            Int
  tenant_user_id     Int
  start_date         DateTime?            @db.Date
  end_date           DateTime?            @db.Date
  rent_amount        Decimal?             @db.Decimal(12, 2)
  deposit_amount     Decimal?             @db.Decimal(12, 2)
  status             contract_status?     @default(pending)
  created_at         DateTime?            @default(now()) @db.Timestamp(6)
  updated_at         DateTime?            @updatedAt @db.Timestamp(6)
  deleted_at         DateTime?            @db.Timestamp(6)
  s3_key             String?              @db.VarChar(500)
  file_name          String?              @db.VarChar(255)
  checksum           String?              @db.VarChar(255)
  uploaded_at        DateTime?            @db.Timestamp(6)
  note               String?
  contract_addendums contract_addendums[]
  rooms              rooms                @relation(fields: [room_id], references: [room_id], map: "fk_contracts_room")
  tenants            tenants              @relation(fields: [tenant_user_id], references: [user_id], map: "fk_contracts_tenant")

  @@index([room_id], map: "idx_contracts_room_id")
  @@index([tenant_user_id], map: "idx_contracts_tenant_user_id")
}

model floor_plans {
  plan_id      Int       @id @default(autoincrement())
  building_id  Int
  name         String?   @db.VarChar(200)
  floor_number Int?
  version      Int?      @default(1)
  layout       Json?
  file_url     String?   @db.VarChar(1000)
  is_published Boolean?  @default(false)
  created_by   Int
  created_at   DateTime? @default(now()) @db.Timestamp(6)
  updated_at   DateTime? @db.Timestamp(6)
  note         String?
  buildings    buildings @relation(fields: [building_id], references: [building_id], onDelete: Cascade, map: "fk_floor_plans_building")
  users        users     @relation(fields: [created_by], references: [user_id], onDelete: SetNull, map: "fk_floor_plans_created_by")

  @@unique([building_id, floor_number, version], map: "floor_plans_unique_building_floor_version")
  @@index([building_id], map: "idx_floor_plans_building_id")
}

model guest_registrations {
  registration_id                               Int             @id @default(autoincrement())
  host_user_id                                  Int
  guest_count                                   Int?            @default(1)
  room_id                                       Int?
  arrival_date                                  DateTime?       @db.Date
  departure_date                                DateTime?       @db.Date
  status                                        guest_status?   @default(pending)
  note                                          String?
  created_at                                    DateTime?       @default(now()) @db.Timestamp(6)
  submitted_at                                  DateTime?       @db.Timestamp(6)
  approved_by                                   Int?
  approved_at                                   DateTime?       @db.Timestamp(6)
  cancelled_at                                  DateTime?       @db.Timestamp(6)
  cancelled_by                                  Int?
  cancellation_reason                           String?         @db.VarChar(500)
  users_guest_registrations_approved_byTousers  users?          @relation("guest_registrations_approved_byTousers", fields: [approved_by], references: [user_id], map: "fk_guest_approved_by")
  users_guest_registrations_cancelled_byTousers users?          @relation("guest_registrations_cancelled_byTousers", fields: [cancelled_by], references: [user_id], map: "fk_guest_cancelled_by")
  tenants                                       tenants         @relation(fields: [host_user_id], references: [user_id], onDelete: Cascade, map: "fk_guest_host")
  rooms                                         rooms?          @relation(fields: [room_id], references: [room_id], map: "fk_guest_room")
  guest_details                                 guest_details[]

  @@index([host_user_id], map: "idx_guest_registrations_host_user_id")
  @@index([room_id], map: "idx_guest_registrations_room_id")
  @@index([status], map: "idx_guest_registrations_status")
}

model guest_details {
  detail_id           Int                 @id @default(autoincrement())
  registration_id     Int
  full_name           String              @db.VarChar(200)
  id_type             id_type?            @default(national_id)
  id_number           String?             @db.VarChar(100)
  date_of_birth       DateTime?           @db.Date
  nationality         String?             @db.VarChar(100)
  gender              String?             @db.VarChar(10)
  relationship        guest_relationship?
  note                String?             @db.VarChar(255)
  guest_registrations guest_registrations @relation(fields: [registration_id], references: [registration_id], onDelete: Cascade, map: "fk_guest_details_registration")

  @@index([registration_id], map: "idx_guest_details_registration_id")
}

model maintenance_requests {
  request_id     Int                   @id @default(autoincrement())
  tenant_user_id Int
  room_id        Int?
  title          String                @db.VarChar(200)
  description    String?
  category       maintenance_category?
  priority       maintenance_priority? @default(normal)
  status         maintenance_status?   @default(pending)
  approved_by    Int?
  created_at     DateTime?             @default(now()) @db.Timestamp(6)
  updated_at     DateTime?             @updatedAt @db.Timestamp(6)
  approved_at    DateTime?             @db.Timestamp(6)
  resolved_at    DateTime?             @db.Timestamp(6)
  note           String?
  users          users?                @relation(fields: [approved_by], references: [user_id], map: "fk_maint_approved_by")
  rooms          rooms?                @relation(fields: [room_id], references: [room_id], map: "fk_maint_room")
  tenants        tenants               @relation(fields: [tenant_user_id], references: [user_id], onDelete: Cascade, map: "fk_maint_tenant")

  @@index([approved_by], map: "idx_maintenance_requests_approved_by")
  @@index([room_id], map: "idx_maintenance_requests_room_id")
  @@index([status], map: "idx_maintenance_requests_status")
  @@index([tenant_user_id], map: "idx_maintenance_requests_tenant_user_id")
}

model notifications {
  notification_id  Int                    @id @default(autoincrement())
  title            String?                @db.VarChar(300)
  body             String?
  priority         notification_priority? @default(normal)
  payload          Json?
  created_by       Int?
  created_at       DateTime?              @default(now()) @db.Timestamp(6)
  users            users?                 @relation(fields: [created_by], references: [user_id], map: "fk_notifications_created_by")
  user_notifications user_notifications[]

  @@index([created_by], map: "idx_notifications_created_by")
}

// This links a User to a Notification and tracks read status.
model user_notifications {
  user_notification_id Int       @id @default(autoincrement())
  notification_id      Int       // The ID of the message content
  user_id              Int       // The ID of the recipient
  is_read              Boolean   @default(false)
  read_at              DateTime? @db.Timestamp(6)
  
  notification         notifications @relation(fields: [notification_id], references: [notification_id], onDelete: Cascade)
  user                 users         @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@unique([notification_id, user_id]) // Prevent duplicate notifications
  @@index([user_id])
}

// Stores device tokens for Firebase (FCM)
model device_tokens {
  token_id    Int          @id @default(autoincrement())
  user_id     Int
  token       String       @unique @db.VarChar(500) // The token from Google/Apple
  device_type device_type?
  created_at  DateTime     @default(now()) @db.Timestamp(6)
  
  user        users        @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id])
}

model regulations {
  regulation_id        Int                    @id @default(autoincrement())
  title                String                 @db.VarChar(255)
  content              String?
  building_id          Int?
  effective_date       DateTime?              @db.Date
  version              Int?                   @default(1)
  status               regulation_status?     @default(draft)
  target               regulation_target?     @default(all)
  created_by           Int
  created_at           DateTime?              @default(now()) @db.Timestamp(6)
  updated_at           DateTime?              @db.Timestamp(6)
  archived_at          DateTime?              @db.Timestamp(6)
  note                 String?
  buildings            buildings?             @relation(fields: [building_id], references: [building_id], map: "fk_regulations_building")
  users                users                  @relation(fields: [created_by], references: [user_id], onDelete: SetNull, map: "fk_regulations_created_by")
  regulation_feedbacks regulation_feedbacks[]

  @@index([building_id], map: "idx_regulations_building_id")
  @@index([status], map: "idx_regulations_status")
}

model regulation_feedbacks {
  feedback_id   Int         @id @default(autoincrement())
  regulation_id Int
  created_by    Int
  comment       String?
  created_at    DateTime?   @default(now()) @db.Timestamp(6)
  regulations   regulations @relation(fields: [regulation_id], references: [regulation_id], map: "fk_regulations_feedbacks")
  users         users       @relation(fields: [created_by], references: [user_id], map: "fk_regulations_created_by")
}

model rooms {
  room_id              Int                    @id @default(autoincrement())
  building_id          Int
  room_number          String                 @db.VarChar(50)
  floor                Int?
  size                 String?                @db.VarChar(50)
  description          String?
  is_active            Boolean?               @default(true)
  status               room_status?           @default(available)
  created_at           DateTime?              @default(now()) @db.Timestamp(6)
  updated_at           DateTime?              @updatedAt @db.Timestamp(6)
  contracts            contracts[]
  guest_registrations  guest_registrations[]
  maintenance_requests maintenance_requests[]
  tenants              tenants[] // thêm mối quan hệ ngược lại
  buildings            buildings              @relation(fields: [building_id], references: [building_id], map: "fk_rooms_building")
  bills                bills[]

  @@unique([building_id, room_number], map: "rooms_building_room_unique")
  @@index([building_id], map: "idx_rooms_building_id")
}

model tenants {
  user_id                 Int                    @id
  room_id                 Int?
  tenant_since            DateTime?              @db.Date
  emergency_contact_phone String?                @db.VarChar(20)
  id_number               String                 @unique @db.VarChar(50)
  note                    String?
  bills                   bills[]
  contracts               contracts[]
  guest_registrations     guest_registrations[]
  maintenance_requests    maintenance_requests[]
  users                   users                  @relation(fields: [user_id], references: [user_id], onDelete: Cascade, map: "fk_tenants_user")
  vehicle_registration    vehicle_registration[]
  vehicles                vehicles[]             @relation("TenantVehiclesRelation")
  rooms                   rooms?                 @relation(fields: [room_id], references: [room_id], map: "fk_tenants_room")

  @@index([room_id], map: "idx_tenants_room_id")
}

model users {
  user_id                                                     Int                    @id @default(autoincrement())
  phone                                                       String                 @unique @db.VarChar(20)
  email                                                       String                 @unique @db.VarChar(200)
  password_hash                                               String                 @db.VarChar(255)
  full_name                                                   String?                @db.VarChar(200)
  gender                                                      String?                @db.VarChar(10)
  birthday                                                    DateTime?              @db.Date
  avatar_url                                                  String?                @db.VarChar(255)
  status                                                      String?                @default("Active") @db.VarChar(20)
  role                                                        Role?                  @default(USER)
  created_at                                                  DateTime?              @default(now()) @db.Timestamp(6)
  updated_at                                                  DateTime?              @db.Timestamp(6)
  deleted_at                                                  DateTime?              @db.Timestamp(6)
  bill_payments                                               bill_payments[]
  bills                                                       bills[]
  building_managers                                           building_managers?
  building_owner                                              building_owner?
  contract_addendums                                          contract_addendums[]
  floor_plans                                                 floor_plans[]
  guest_registrations_guest_registrations_approved_byTousers  guest_registrations[]  @relation("guest_registrations_approved_byTousers")
  guest_registrations_guest_registrations_cancelled_byTousers guest_registrations[]  @relation("guest_registrations_cancelled_byTousers")
  maintenance_requests                                        maintenance_requests[]
  notifications                                               notifications[]
  regulations                                                 regulations[]
  tenants                                                     tenants?
  vehicle_registration                                        vehicle_registration[]
  vehicles                                                    vehicles[]
  is_verified                                                 Boolean?               @default(false)
  regulation_feedbacks                                        regulation_feedbacks[]
  user_notifications                                          user_notifications[]
  device_tokens                                               device_tokens[]
}

model vehicle_registration {
  assignment_id Int                  @id @default(autoincrement())
  requested_by  Int
  requested_at  DateTime?            @default(now()) @db.Timestamp(6)
  updated_at    DateTime?            @updatedAt @db.Timestamp(6)
  status        registration_status? @default(requested)
  approved_by   Int?
  approved_at   DateTime?            @db.Timestamp(6)
  canceled_at   DateTime?            @db.Timestamp(6)
  canceled_by   Int?
  reason        String?              @db.VarChar(300)
  start_date    DateTime?            @db.Date
  end_date      DateTime?            @db.Date
  note          String?              @db.VarChar(500)
  users         users?               @relation(fields: [approved_by], references: [user_id], map: "fk_vehicle_approved_by")
  tenants       tenants              @relation(fields: [requested_by], references: [user_id], onDelete: Cascade, map: "fk_vehicle_requested_by")
  vehicles      vehicles[]

  @@index([requested_by], map: "idx_vehicle_slot_requested_by")
  @@index([status], map: "idx_vehicle_slot_status")
}

model vehicles {
  vehicle_id           Int                   @id @default(autoincrement())
  tenant_user_id       Int
  registration_id      Int
  type                 vehicle_type?
  license_plate        String?               @db.VarChar(50)
  brand                String?               @db.VarChar(100)
  color                String?               @db.VarChar(50)
  status               vehicle_status?       @default(requested)
  registered_at        DateTime?             @default(now()) @db.Timestamp(6)
  updated_at           DateTime?             @db.Timestamp(6)
  deactivated_at       DateTime?             @db.Timestamp(6)
  deactivated_by       Int?
  note                 String?
  users                users?                @relation(fields: [deactivated_by], references: [user_id], map: "fk_vehicles_deactivated_by")
  tenants              tenants               @relation("TenantVehiclesRelation", fields: [tenant_user_id], references: [user_id], onDelete: Cascade, map: "fk_vehicles_tenant")
  vehicle_registration vehicle_registration? @relation(fields: [registration_id], references: [assignment_id], map: "fk_vehicles_registration")

  @@unique([license_plate], map: "uq_vehicles_license_plate")
  @@index([tenant_user_id], map: "idx_vehicles_tenant_user_id")
  @@index([license_plate], map: "idx_vehicles_license_plate")
}

enum addendum_status {
  draft
  pending_approval
  approved
  rejected
  cancelled
}

enum addendum_type {
  extension
  rent_change
  early_termination
  general
  other
}

enum bill_status {
  draft
  issued
  partially_paid
  paid
  overdue
  cancelled
}

enum contract_status {
  pending
  active
  terminated
  expired
}

enum guest_status {
  pending
  approved
  rejected
  cancelled
  expired
}

enum id_type {
  national_id
  passport
  other
}

enum maintenance_category {
  plumbing
  electrical
  hvac
  carpentry
  cleaning
  other
}

enum maintenance_priority {
  low
  normal
  high
  urgent
}

enum maintenance_status {
  pending
  in_progress
  on_hold
  resolved
  completed
  cancelled
  rejected
}

enum notification_priority {
  low
  normal
  high
}

enum notification_status {
  queued
  sending
  sent
  delivered
  failed
  cancelled
}

enum payment_method {
  cash
  bank_transfer
  card
  online
  other
}

enum payment_status {
  pending
  completed
  failed
  refunded
}

enum registration_status {
  requested
  approved
  rejected
  cancelled
  expired
}

enum regulation_status {
  draft
  published
  archived
  deleted
}

enum Role {
  TENANT
  MANAGER
  OWNER
  USER
}

enum vehicle_type {
  car
  motorcycle
  truck
  van
  other
}

enum vehicle_status {
  active
  inactive
  requested
  deactivated
}

enum guest_relationship {
  host
  spouse
  child
  parent
  sibling
  friend
  colleague
  other
}

enum online_type {
  VNPAY
  VIETQR
}

enum room_status {
  available
  occupied
  maintenance
  reserved
}

enum regulation_target {
  all
  tenants
  management
}

enum device_type {
  IOS
  ANDROID
  WEB
}
