generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum Role {
  TENANT
  MANAGER
  OWNER
  USER
}

enum ConsentType {
  TERM_OF_SERVICE
  PRIVACY_POLICY
  CONTRACT_SIGNING
  CONTRACT_TERMINATION
  CONTRACT_ADDENDUM

  @@map("consent_type")
}

enum addendum_status {
  draft
  pending_approval
  approved
  expired
  rejected
}

enum ConsentAction {
  ACCEPTED
  REVOKED
  UPDATED
}

enum addendum_type {
  extension
  rent_adjustment
  deposit_adjustment
  payment_terms_change
  general_amendment
}

enum bill_status {
  draft
  issued
  partially_paid
  paid
  overdue
  cancelled
}

enum bill_type {
  monthly_rent
  utilities
  maintenance
  penalty
  deposit
  other
}

enum contract_status {
  pending
  rejected
  pending_transaction
  active
  terminated
  requested_termination
  expired
}

enum device_type {
  IOS
  ANDROID
  WEB
}

enum guest_relationship {
  host
  spouse
  child
  parent
  sibling
  friend
  colleague
  other
}

enum guest_status {
  pending
  approved
  rejected
  cancelled
  expired
}

enum id_type {
  national_id
  passport
  other
}

enum maintenance_category {
  plumbing
  electrical
  hvac
  carpentry
  cleaning
  other
}

enum maintenance_priority {
  low
  normal
  high
  urgent
}

enum maintenance_status {
  pending
  in_progress
  on_hold
  resolved
  completed
  cancelled
  rejected
}

enum notification_priority {
  low
  normal
  high
}

enum notification_status {
  queued
  sending
  sent
  delivered
  failed
  cancelled
}

enum online_type {
  VNPAY
  VIETQR
  PAYOS
}

enum payment_method {
  cash
  bank_transfer
  card
  online
  other
}

enum payment_status {
  pending
  completed
  failed
  refunded
}

enum registration_status {
  requested
  approved
  rejected
  cancelled
  expired
}

enum regulation_status {
  draft
  published
  archived
  deleted
}

enum regulation_target {
  all
  tenants
  management
}

enum room_status {
  available
  occupied
  maintenance
}

enum vehicle_status {
  active
  inactive
  requested
  deactivated
}

enum vehicle_type {
  two_wheeler
  four_wheeler
}

enum tenant_type {
  primary
  secondary
}

// ============================================
// CORE TABLES
// ============================================

model users {
  user_id       Int       @id @default(autoincrement())
  phone         String    @unique @db.VarChar(20)
  email         String    @unique @db.VarChar(200)
  password_hash String    @db.VarChar(255)
  full_name     String?   @db.VarChar(200)
  gender        String?   @db.VarChar(10)
  birthday      DateTime? @db.Date
  avatar_url    String?   @db.VarChar(255)
  status        String?   @default("Active") @db.VarChar(20)
  role          Role?     @default(USER)
  is_verified   Boolean?  @default(false)
  created_at    DateTime? @default(now()) @db.Timestamp(6)
  updated_at    DateTime? @updatedAt @db.Timestamp(6)
  deleted_at    DateTime? @db.Timestamp(6)

  // Relations
  tenants           tenants?
  building_managers building_managers[]
  device_tokens     device_tokens[]

  // Relations: Notifications
  notifications_created notifications[]      @relation("NotifCreatedBy")
  user_notifications    user_notifications[]

  // Relations: Billing
  bills_created bills[]         @relation("BillCreatedBy")
  payments_made bill_payments[] @relation("PaymentPaidBy")

  // Relations: Contracts & Docs
  addendums_created contract_addendums[] @relation("AddendumCreatedBy")

  // Relations: Floor Plans & Regulations
  floor_plans_created   floor_plans[]          @relation("FloorPlanCreatedBy")
  floor_plans_published floor_plans[]          @relation("FloorPlanPublishedBy")
  regulations_created   regulations[]          @relation("RegulationCreatedBy")
  regulations_published regulations[]          @relation("RegulationPublishedBy")
  regulation_feedbacks  regulation_feedbacks[]

  // Relations: Maintenance
  maintenance_approved maintenance_requests[] @relation("MaintenanceApprovedBy")
  maintenance_assigned maintenance_requests[] @relation("MaintenanceAssignedTo")

  // Relations: Guests
  guest_registrations_approved  guest_registrations[] @relation("GuestRegApprovedBy")
  guest_registrations_cancelled guest_registrations[] @relation("GuestRegCancelledBy")

  // Relations: Vehicles
  vehicle_reg_approved  vehicle_registrations[] @relation("VehicleRegApprovedBy")
  vehicle_reg_rejected  vehicle_registrations[] @relation("VehicleRegRejectedBy")
  vehicle_reg_cancelled vehicle_registrations[] @relation("VehicleRegCancelledBy")
  vehicles_deactivated  vehicles[]              @relation("VehicleDeactivatedBy")

  utility_recorded utility_readings[] @relation("UtilityRecordedBy")
  consentLogs      consent_logs[]
}

model tenants {
  user_id      Int       @id
  building_id  Int?
  id_number    String    @unique @db.VarChar(50)
  tenant_since DateTime? @db.Date
  note         String?

  // Relations
  user                 users          @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  room_tenants_history room_tenants[]
  building             buildings?     @relation(fields: [building_id], references: [building_id])
  // Contracts & Bills
  contracts            contracts[]
  bills                bills[]

  // Requests
  vehicle_registrations vehicle_registrations[] @relation("VehicleRegRequestedBy")
  vehicles              vehicles[]              @relation("VehicleTenant")
  maintenance_requests  maintenance_requests[]
  guest_registrations   guest_registrations[]   @relation("GuestHost")
}

model buildings {
  building_id         Int       @id @default(autoincrement())
  name                String    @db.VarChar(200)
  address             String?   @db.VarChar(300)
  number_of_floors    Int?
  total_area          Float?
  electric_unit_price Decimal?  @db.Decimal(12, 2)
  water_unit_price    Decimal?  @db.Decimal(12, 2)
  service_fee         Decimal?  @db.Decimal(12, 2)
  bill_closing_day    Int?      // The cut-off date (1-28)
  max_4_wheel_slot    Int? // số xe 4 bánh tối đa
  max_2_wheel_slot    Int? // số xe 2 bánh tối đa
  is_active           Boolean?  @default(true)
  created_at          DateTime? @default(now()) @db.Timestamp(6)
  updated_at          DateTime? @updatedAt @db.Timestamp(6)

  // Relations
  building_managers building_managers[]
  rooms             rooms[]
  floor_plans       floor_plans[]
  regulations       regulations[]
  parking_slots     parking_slots[]
  tenants           tenants[]
}

model building_managers {
  manager_id  Int     @id @default(autoincrement())
  user_id     Int
  building_id Int
  note        String? @db.VarChar(255)

  building buildings @relation(fields: [building_id], references: [building_id], onDelete: Cascade)
  user     users     @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([building_id], map: "idx_building_managers_building_id")
  @@index([user_id], map: "idx_building_managers_user_id")
}

model rooms {
  room_id             Int          @id @default(autoincrement())
  building_id         Int
  room_number         String       @db.VarChar(50)
  floor               Int?
  size                Decimal?     @db.Decimal(10, 2) // Area in square meters
  max_occupants       Int?
  max_tenants         Int?         @default(1)
  current_contract_id Int?         @unique
  status              room_status? @default(available)
  description         String?
  is_active           Boolean?     @default(true)
  created_at          DateTime?    @default(now()) @db.Timestamp(6)
  updated_at          DateTime?    @updatedAt @db.Timestamp(6)

  // Relations
  building         buildings  @relation(fields: [building_id], references: [building_id])
  current_contract contracts? @relation("RoomCurrentContract", fields: [current_contract_id], references: [contract_id])

  // Opposite relations
  contracts_history    contracts[]            @relation("RoomContractsHistory")
  room_tenants         room_tenants[]
  maintenance_requests maintenance_requests[]
  guest_registrations  guest_registrations[]
  utility_readings     utility_readings[]

  @@unique([building_id, room_number], map: "unique_building_room")
  @@index([building_id], map: "idx_rooms_building_id")
  @@index([status], map: "idx_rooms_status")
}

model room_tenants {
  room_tenant_id Int         @id @default(autoincrement())
  room_id        Int
  tenant_user_id Int
  tenant_type    tenant_type
  moved_in_at    DateTime    @db.Date
  moved_out_at   DateTime?   @db.Date
  is_current     Boolean     @default(false)
  note           String?
  created_at     DateTime?   @default(now()) @db.Timestamp(6)

  room   rooms   @relation(fields: [room_id], references: [room_id], onDelete: Cascade)
  tenant tenants @relation(fields: [tenant_user_id], references: [user_id], onDelete: Cascade)

  @@index([room_id, tenant_user_id, is_current], map: "idx_room_tenants_room_tenant_current")
  @@index([room_id], map: "idx_room_tenants_room")
  @@index([tenant_user_id], map: "idx_room_tenants_tenant")
  @@index([room_id, tenant_type, is_current], map: "idx_room_tenants_type_current")
  @@unique([tenant_user_id, tenant_type, is_current], map: "uniq_tenant_type_current")
}

// ============================================
// CONTRACT MANAGEMENT
// ============================================

model contracts {
  contract_id          Int              @id @default(autoincrement())
  room_id              Int
  tenant_user_id       Int
  contract_number      String           @unique @db.VarChar(50)
  start_date           DateTime         @db.Date
  end_date             DateTime         @db.Date
  duration_months      Int
  rent_amount          Decimal          @db.Decimal(12, 2)
  deposit_amount       Decimal          @db.Decimal(12, 2)
  penalty_rate         Decimal?         @db.Decimal(5, 2)
  payment_cycle_months Int              @default(1)
  status               contract_status? @default(pending)
  file_name            String?          @db.VarChar(255)
  s3_key               String?          @db.VarChar(500)
  checksum             String?          @db.VarChar(255)
  note                 String?
  created_at           DateTime?        @default(now()) @db.Timestamp(6)
  updated_at           DateTime?        @updatedAt @db.Timestamp(6)
  uploaded_at          DateTime?        @db.Timestamp(6)
  deleted_at           DateTime?        @db.Timestamp(6)
  tenant_accepted_at   DateTime?        @db.Timestamp(6)
  // Relations
  room_history         rooms            @relation("RoomContractsHistory", fields: [room_id], references: [room_id])
  room_current         rooms?           @relation("RoomCurrentContract") // Opposite side of 1-1
  tenant               tenants          @relation(fields: [tenant_user_id], references: [user_id])

  contract_addendums contract_addendums[]
  bills              bills[]
  consentLogs        consent_logs[]

  @@index([room_id], map: "idx_contracts_room_id")
  @@index([tenant_user_id], map: "idx_contracts_tenant_user_id")
  @@index([status], map: "idx_contracts_status")
  @@index([room_id, status], map: "idx_contracts_room_status")
  @@index([room_id, start_date, end_date], map: "idx_contracts_room_dates")
}

model contract_addendums {
  addendum_id     Int             @id @default(autoincrement())
  contract_id     Int
  addendum_number Int
  addendum_type   addendum_type
  status          addendum_status

  file_name   String?   @db.VarChar(255)
  s3_key      String?   @db.VarChar(500)
  checksum    String?   @db.VarChar(255)
  uploaded_at DateTime? @db.Timestamp(6)

  effective_from   DateTime?
  effective_to     DateTime?
  changes_snapshot Json?

  note String? @db.Text

  created_by Int

  created_at         DateTime? @default(now()) @db.Timestamp(6)
  updated_at         DateTime? @updatedAt @db.Timestamp(6)
  tenant_accepted_at DateTime? @db.Timestamp(6)

  contract contracts @relation(fields: [contract_id], references: [contract_id], onDelete: Cascade)
  creator  users     @relation("AddendumCreatedBy", fields: [created_by], references: [user_id])

  @@index([contract_id], map: "idx_contract_addendums_contract_id")
  @@index([created_by], map: "idx_contract_addendums_created_by")
}

model consent_logs {
  log_id      Int  @id @default(autoincrement())
  user_id     Int
  contract_id Int?
  addendum_id Int?

  // Reference đến version cụ thể thay vì duplicate content
  version_id Int
  action     ConsentAction @default(ACCEPTED)

  // Bằng chứng kỹ thuật
  ip_address  String  @db.VarChar(45) // IPv4/IPv6
  device_info String? @db.VarChar(500) // Tăng lên để lưu đầy đủ user agent

  // Hash của toàn bộ consent context để verify integrity
  data_hash String @db.VarChar(64) // SHA256 = 64 chars

  // Session tracking
  session_id String? @db.VarChar(100)

  // Timestamps
  created_at DateTime @default(now()) @db.Timestamp(6)

  // Relations
  user     users            @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  contract contracts?       @relation(fields: [contract_id], references: [contract_id], onDelete: SetNull)
  version  consent_versions @relation(fields: [version_id], references: [version_id])

  // Indexes được tối ưu theo use case
  @@index([user_id, created_at(sort: Desc)]) // Query logs của user theo thời gian
  @@index([contract_id, created_at(sort: Desc)]) // Query logs của contract
  @@index([version_id]) // Join với consent_versions
  @@index([data_hash]) // Verify integrity, detect duplicates
  @@map("consent_logs")
}

// ============================================
// BẢNG PHỤ: Lưu các version của Terms/Policy
// ============================================
model consent_versions {
  version_id Int @id @default(autoincrement())

  // Version info
  consent_type   ConsentType
  version_number String      @db.VarChar(20) // "v1.0", "v2.1"

  // Content
  content      String @db.Text // Nội dung đầy đủ
  content_hash String @db.VarChar(64) // SHA256 hash để verify integrity

  // Status management
  is_active Boolean @default(false) // Chỉ 1 version active cho mỗi type

  // Timestamps
  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @updatedAt @db.Timestamp(6)

  is_major_update Boolean @default(true)

  // Relations
  consent_logs consent_logs[]

  // Constraints
  @@unique([consent_type, version_number]) // Không duplicate version
  @@index([consent_type, is_active]) // Get active version
  @@index([content_hash]) // Verify integrity
  @@map("consent_versions")
}

// ============================================
// BILLING SYSTEM
// ============================================

model bill_payments {
  payment_id     Int             @id @default(autoincrement())
  amount         Decimal         @db.Decimal(12, 2)
  payment_date   DateTime        @default(now()) @db.Timestamp(6)
  method         payment_method
  status         payment_status? @default(completed)
  reference      String?         @db.VarChar(255)
  transaction_id String?         @unique @db.VarChar(100)
  online_type    online_type?
  paid_by        Int?
  note           String?         @db.VarChar(500)

  payer            users?                 @relation("PaymentPaidBy", fields: [paid_by], references: [user_id])
  payment_details  bill_payment_details[]
  utility_readings utility_readings[]

  @@index([transaction_id], map: "unique_transaction_id") // Already unique, but keeping for DBML fidelity
  @@index([paid_by], map: "idx_bill_payments_paid_by")
  @@index([payment_date], map: "idx_bill_payments_date")
}

model bills {
  bill_id              Int          @id @default(autoincrement())
  bill_number          String       @unique @db.VarChar(100)
  contract_id          Int
  tenant_user_id       Int
  billing_period_start DateTime     @db.Date
  billing_period_end   DateTime     @db.Date
  due_date             DateTime     @db.Date
  bill_type            bill_type    @default(monthly_rent)
  total_amount         Decimal      @default(0) @db.Decimal(12, 2)
  paid_amount          Decimal      @default(0) @db.Decimal(12, 2)
  penalty_amount       Decimal?     @default(0) @db.Decimal(12, 2)
  status               bill_status? @default(draft)
  description          String?
  created_by           Int?
  created_at           DateTime?    @default(now()) @db.Timestamp(6)
  updated_at           DateTime?    @updatedAt @db.Timestamp(6)
  deleted_at           DateTime?    @db.Timestamp(6)

  contract contracts @relation(fields: [contract_id], references: [contract_id])
  tenant   tenants   @relation(fields: [tenant_user_id], references: [user_id])
  creator  users?    @relation("BillCreatedBy", fields: [created_by], references: [user_id])

  payment_details bill_payment_details[]
  service_charges bill_service_charges[]
  utilityReadings utility_readings[]

  @@index([contract_id], map: "idx_bills_contract_id")
  @@index([tenant_user_id], map: "idx_bills_tenant_user_id")
  @@index([status], map: "idx_bills_status")
  @@index([due_date], map: "idx_bills_due_date")
}

model bill_payment_details {
  detail_id  Int       @id @default(autoincrement())
  bill_id    Int
  payment_id Int
  amount     Decimal   @db.Decimal(12, 2)
  created_at DateTime? @default(now()) @db.Timestamp(6)

  bill    bills         @relation(fields: [bill_id], references: [bill_id], onDelete: Cascade)
  payment bill_payments @relation(fields: [payment_id], references: [payment_id], onDelete: Cascade)

  @@unique([bill_id, payment_id], map: "unique_bill_payment")
  @@index([bill_id], map: "idx_bill_payment_details_bill")
  @@index([payment_id], map: "idx_bill_payment_details_payment")
}

model bill_service_charges {
  charge_id    Int      @id @default(autoincrement())
  bill_id      Int
  service_type String   @db.VarChar(100)
  quantity     Decimal? @db.Decimal(10, 2)
  unit_price   Decimal? @db.Decimal(12, 2)
  amount       Decimal  @db.Decimal(12, 2)
  description  String?

  bill bills @relation(fields: [bill_id], references: [bill_id], onDelete: Cascade)

  @@index([bill_id], map: "idx_bill_service_charges_bill")
}

// ============================================
// PARKING MANAGEMENT
// ============================================

model parking_slots {
  slot_id      Int          @id @default(autoincrement())
  building_id  Int
  slot_number  String       @db.VarChar(50)
  slot_type    vehicle_type
  is_available Boolean?     @default(true)
  created_at   DateTime?    @default(now()) @db.Timestamp(6)

  building buildings  @relation(fields: [building_id], references: [building_id], onDelete: Cascade)
  vehicles vehicles[]

  @@unique([building_id, slot_number], map: "unique_building_slot")
  @@index([building_id], map: "idx_parking_slots_building")
}

model vehicle_registrations {
  registration_id Int                  @id @default(autoincrement())
  requested_by    Int
  vehicle_type    vehicle_type
  license_plate   String               @db.VarChar(50)
  brand           String?              @db.VarChar(100)
  color           String?              @db.VarChar(50)
  start_date      DateTime             @db.Date
  end_date        DateTime?            @db.Date
  status          registration_status? @default(requested)
  requested_at    DateTime?            @default(now()) @db.Timestamp(6)
  approved_by     Int?
  approved_at     DateTime?            @db.Timestamp(6)
  rejected_by     Int?
  rejected_at     DateTime?            @db.Timestamp(6)
  cancelled_by    Int?
  cancelled_at    DateTime?            @db.Timestamp(6)
  reason          String?              @db.VarChar(300)
  note            String?              @db.VarChar(500)
  updated_at      DateTime?            @updatedAt @db.Timestamp(6)

  requester tenants @relation("VehicleRegRequestedBy", fields: [requested_by], references: [user_id], onDelete: Cascade)
  approver  users?  @relation("VehicleRegApprovedBy", fields: [approved_by], references: [user_id])
  rejector  users?  @relation("VehicleRegRejectedBy", fields: [rejected_by], references: [user_id])
  canceller users?  @relation("VehicleRegCancelledBy", fields: [cancelled_by], references: [user_id])

  vehicle vehicles?

  @@index([requested_by], map: "idx_vehicle_reg_requested_by")
  @@index([status], map: "idx_vehicle_reg_status")
  @@index([license_plate], map: "idx_vehicle_reg_license_plate")
}

model vehicles {
  vehicle_id      Int             @id @default(autoincrement())
  registration_id Int             @unique
  license_plate   String?         @db.VarChar(20)
  tenant_user_id  Int
  slot_id         Int?
  status          vehicle_status? @default(active)
  registered_at   DateTime?       @default(now()) @db.Timestamp(6)
  deactivated_at  DateTime?       @db.Timestamp(6)
  deactivated_by  Int?
  note            String?
  updated_at      DateTime?       @updatedAt @db.Timestamp(6)

  registration vehicle_registrations @relation(fields: [registration_id], references: [registration_id])
  tenant       tenants               @relation("VehicleTenant", fields: [tenant_user_id], references: [user_id], onDelete: Cascade)
  slot         parking_slots?        @relation(fields: [slot_id], references: [slot_id])
  deactivator  users?                @relation("VehicleDeactivatedBy", fields: [deactivated_by], references: [user_id])

  @@index([tenant_user_id], map: "idx_vehicles_tenant_user_id")
  @@index([slot_id], map: "idx_vehicles_slot_id")
  @@index([status], map: "idx_vehicles_status")
}

// ============================================
// MAINTENANCE & REQUESTS
// ============================================

model maintenance_requests {
  request_id     Int                   @id @default(autoincrement())
  tenant_user_id Int
  room_id        Int?
  title          String                @db.VarChar(200)
  description    String?
  category       maintenance_category?
  priority       maintenance_priority? @default(normal)
  status         maintenance_status?   @default(pending)
  approved_by    Int?
  approved_at    DateTime?             @db.Timestamp(6)
  assigned_to    Int?
  assigned_at    DateTime?             @db.Timestamp(6)
  resolved_at    DateTime?             @db.Timestamp(6)
  note           String?
  created_at     DateTime?             @default(now()) @db.Timestamp(6)
  updated_at     DateTime?             @updatedAt @db.Timestamp(6)

  tenant   tenants @relation(fields: [tenant_user_id], references: [user_id], onDelete: Cascade)
  room     rooms?  @relation(fields: [room_id], references: [room_id])
  approver users?  @relation("MaintenanceApprovedBy", fields: [approved_by], references: [user_id])
  assignee users?  @relation("MaintenanceAssignedTo", fields: [assigned_to], references: [user_id])

  @@index([tenant_user_id], map: "idx_maintenance_requests_tenant")
  @@index([room_id], map: "idx_maintenance_requests_room")
  @@index([status], map: "idx_maintenance_requests_status")
  @@index([approved_by], map: "idx_maintenance_requests_approved_by")
  @@index([assigned_to], map: "idx_maintenance_requests_assigned_to")
}

// ============================================
// GUEST MANAGEMENT
// ============================================

model guest_registrations {
  registration_id     Int           @id @default(autoincrement())
  host_user_id        Int
  room_id             Int
  arrival_date        DateTime      @db.Date
  departure_date      DateTime      @db.Date
  status              guest_status? @default(pending)
  approved_by         Int?
  approved_at         DateTime?     @db.Timestamp(6)
  note                String?
  created_at          DateTime?     @default(now()) @db.Timestamp(6)
  submitted_at        DateTime?     @db.Timestamp(6)
  cancelled_by        Int?
  cancelled_at        DateTime?     @db.Timestamp(6)
  cancellation_reason String?       @db.VarChar(500)

  host      tenants @relation("GuestHost", fields: [host_user_id], references: [user_id], onDelete: Cascade)
  room      rooms   @relation(fields: [room_id], references: [room_id])
  approver  users?  @relation("GuestRegApprovedBy", fields: [approved_by], references: [user_id])
  canceller users?  @relation("GuestRegCancelledBy", fields: [cancelled_by], references: [user_id])

  guest_details guest_details[]

  @@index([host_user_id], map: "idx_guest_registrations_host")
  @@index([room_id], map: "idx_guest_registrations_room")
  @@index([status], map: "idx_guest_registrations_status")
}

model guest_details {
  detail_id       Int                 @id @default(autoincrement())
  registration_id Int
  full_name       String              @db.VarChar(200)
  id_type         id_type?            @default(national_id)
  id_number       String?             @db.VarChar(100)
  date_of_birth   DateTime?           @db.Date
  gender          String?             @db.VarChar(10)
  relationship    guest_relationship?
  note            String?             @db.VarChar(255)

  registration guest_registrations @relation(fields: [registration_id], references: [registration_id], onDelete: Cascade)

  @@index([registration_id], map: "idx_guest_details_registration_id")
}

// ============================================
// REGULATIONS & FEEDBACK
// ============================================

model regulations {
  regulation_id  Int                @id @default(autoincrement())
  title          String             @db.VarChar(255)
  content        String
  building_id    Int?
  target         regulation_target? @default(all)
  effective_date DateTime?          @db.Date
  version        Int?               @default(1)
  status         regulation_status? @default(draft)
  created_by     Int
  published_by   Int?
  published_at   DateTime?          @db.Timestamp(6)
  archived_at    DateTime?          @db.Timestamp(6)
  note           String?
  created_at     DateTime?          @default(now()) @db.Timestamp(6)
  updated_at     DateTime?          @updatedAt @db.Timestamp(6)

  building  buildings? @relation(fields: [building_id], references: [building_id])
  creator   users      @relation("RegulationCreatedBy", fields: [created_by], references: [user_id])
  publisher users?     @relation("RegulationPublishedBy", fields: [published_by], references: [user_id])

  feedbacks regulation_feedbacks[]

  @@index([building_id], map: "idx_regulations_building_id")
  @@index([status], map: "idx_regulations_status")
  @@index([effective_date], map: "idx_regulations_effective_date")
}

model regulation_feedbacks {
  feedback_id   Int       @id @default(autoincrement())
  regulation_id Int
  created_by    Int
  comment       String?
  created_at    DateTime? @default(now()) @db.Timestamp(6)

  regulation regulations @relation(fields: [regulation_id], references: [regulation_id], onDelete: Cascade)
  user       users       @relation(fields: [created_by], references: [user_id])

  @@index([regulation_id], map: "idx_regulation_feedbacks_regulation")
  @@index([created_by], map: "idx_regulation_feedbacks_created_by")
}

// ============================================
// FLOOR PLANS
// ============================================

model floor_plans {
  plan_id      Int       @id @default(autoincrement())
  building_id  Int
  name         String?   @db.VarChar(200)
  floor_number Int
  layout       Json?
  file_url     String?   @db.VarChar(1000)
  is_published Boolean?  @default(false)
  created_by   Int
  published_by Int?
  published_at DateTime? @db.Timestamp(6)
  note         String?
  created_at   DateTime? @default(now()) @db.Timestamp(6)
  updated_at   DateTime? @updatedAt @db.Timestamp(6)

  building  buildings @relation(fields: [building_id], references: [building_id], onDelete: Cascade)
  creator   users     @relation("FloorPlanCreatedBy", fields: [created_by], references: [user_id])
  publisher users?    @relation("FloorPlanPublishedBy", fields: [published_by], references: [user_id])

  @@index([building_id], map: "idx_floor_plans_building_id")
}

// ============================================
// NOTIFICATIONS
// ============================================

model notifications {
  notification_id Int                    @id @default(autoincrement())
  title           String                 @db.VarChar(300)
  body            String
  priority        notification_priority? @default(normal)
  payload         Json?
  created_by      Int?
  created_at      DateTime?              @default(now()) @db.Timestamp(6)

  creator            users?               @relation("NotifCreatedBy", fields: [created_by], references: [user_id])
  user_notifications user_notifications[]

  @@index([created_by], map: "idx_notifications_created_by")
  @@index([created_at], map: "idx_notifications_created_at")
}

model user_notifications {
  user_notification_id Int       @id @default(autoincrement())
  notification_id      Int
  user_id              Int
  is_read              Boolean   @default(false)
  read_at              DateTime? @db.Timestamp(6)

  notification notifications @relation(fields: [notification_id], references: [notification_id], onDelete: Cascade)
  user         users         @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@unique([notification_id, user_id], map: "unique_user_notification")
  @@index([user_id], map: "idx_user_notifications_user")
  @@index([notification_id], map: "idx_user_notifications_notification")
}

model device_tokens {
  token_id     Int          @id @default(autoincrement())
  user_id      Int
  token        String       @unique @db.VarChar(500)
  device_type  device_type?
  created_at   DateTime     @default(now()) @db.Timestamp(6)
  last_used_at DateTime?    @db.Timestamp(6)

  user users @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id], map: "idx_device_tokens_user_id")
}

// ============================================
// UTILITIES (ĐIỆN NƯỚC)
// ============================================

model utility_readings {
  reading_id Int  @id @default(autoincrement())
  room_id    Int
  bill_id    Int? // Link tới hóa đơn (nếu đã tạo bill từ chỉ số này)

  recorded_date DateTime @db.Date
  billing_month Int
  billing_year  Int

  prev_electric  Int // Chỉ số điện cũ
  curr_electric  Int // Chỉ số điện mới
  electric_price Decimal @db.Decimal(12, 2) // Giá điện áp dụng tại lúc chốt
  is_electric_reset Boolean @default(false) // Reset nếu thay công tơ

  prev_water  Int // Chỉ số nước cũ
  curr_water  Int // Chỉ số nước mới
  water_price Decimal @db.Decimal(12, 2) // Giá nước áp dụng tại lúc chốt
  is_water_reset Boolean @default(false) // Reset nếu thay công tơ

  created_by Int? // Người ghi số (quản lý)
  created_at DateTime? @default(now()) @db.Timestamp(6)

  // Relations
  room                    rooms          @relation(fields: [room_id], references: [room_id])
  bill                    bills?         @relation(fields: [bill_id], references: [bill_id])
  creator                 users?         @relation("UtilityRecordedBy", fields: [created_by], references: [user_id])
  billPayments            bill_payments? @relation(fields: [bill_paymentsPayment_id], references: [payment_id])
  bill_paymentsPayment_id Int?

  @@unique([room_id, billing_month, billing_year], map: "unique_room_utility_period")
  @@index([room_id], map: "idx_utility_readings_room")
  @@index([recorded_date], map: "idx_utility_readings_date")
  @@index([bill_id], map: "idx_utility_readings_bill")
}
